[基幹システムのインフラ課題をどうやって解決したのか？ OKANの取り組みをご紹介します！](https://www.wantedly.com/id/haruki_uejima)

こんにちは。OKANでエンジニアをしている上島です。今月で社会人3年目を迎えました。今回はOKANのこれまでの基幹システムのインフラの課題を解決していくために、今後のインフラをどのように設計し、構築をしていったのかについてお話しします。

<br/>

## 既存のシステムの課題
OKANの基幹システムのインフラを見直していくにあたって、現在の基幹システムのインフラについて、自分自身が課題に感じていたものを3つ挙げてみます。

1. AWSリソースの管理
2. コストの管理
3. リリースフローの管理

<br/>

### 1. AWSリソースの管理
OKANは全システムのインフラにAWSを使用しています。既存の基幹システムのインフラ環境は AWSマネジメントコンソールから手動で作成されたものでした。作業時のドキュメントが残されていなかったり、どのリソースが何の役割を担っているのか、手がかりがあまり無い状態になっていたりしたため、正しいインフラ構成を把握することが困難な状態になっていました。また、設計思想が統一されておらず、作業を行う人が属人的に進めてしまっており、人為的なミスが起こってしまうリスクがありました。

AWSマネジメントコンソールからリソースを作成した際のリソースへの命名ルールも定めておらず、各々が名前を決めて付けていたので統一性がありませんでした。不要になったAWSリソースの削除漏れなどの残骸がいくつも見つかり、適切なルールを定めて管理ができていなかったことが原因でこのようなことになっていました。

他にも、ドキュメントが残されていないものも多々あり、何か作業が発生するたびに調査が必要な状態になってしまっていました。S3 がどのシステムのどんな用途に使われているのか判断できなかったり、インスタンスがアタッチされていないロードバランサーや、ロードバランサがアタッチされているもののインスタンスが停止済み状態になっていたりとカオスな状態になっていました。

<br/>

### 2. コスト管理
既存システムのAWSリソースには Nameタグが付与されていないことが多々あったので、どのリソースがどのシステムのどの環境のものなのかが把握しにくくなっていました。そのためコストの変動がどのシステムの変更によるものかを把握することができず、コストが増加した原因を探ることが難しい状態になっていました。

以前、開発のために使っていたと思われるAWSリソースが既に不要になっているにも関わらず、削除されずに実行されたままになっていたことや、不要なリソースからの不必要なログが CloudWatch や S3に蓄積されていたこと、最後に使用した形跡が1年以上前のRDS MySQL インスタンスを停止せずに稼働していたことなどもあり無駄なコストをかなり支払ってしまっていました。細かなものも含めると他にもあると思います。

リソースの管理の方法の問題だけではなく、そもそもコストに対する意識がエンジニア自身にほとんど無かったことも課題だと思います。

<br/>

### 3. リリースフローの管理
OKANのエンジニアチームは複数システムの管理・運用をおこなっていますが、リリースフローの定義がシステムごとに異なっていました。例を挙げると、AWS CodePipeline でリリースをおこなっているシステム、Bitbucket Pipelines でリリースをおこなっているシステム、作業手順書をもとに手動でリリースをおこなっているシステムが混在しています。

特に手動でリリースをおこなっているシステムは、ヒューマンエラーが起こりやすい状況になっており、重大なミスに繋がる可能性があります。実際にOKANでも手動でリリースをおこなっているシステムでリリースミスを起こしてしまったことも何度かありました。また、作業手順書はあるものの、少し違ったイレギュラーなものが発生するとその都度調査をしながら進める必要があるので、作業コストも上がりますし、少なからず不安があります。

<br/>

## 新システムのインフラ構成とデプロイフロー
前述の課題を解決していくことを踏まえて、新しいシステムの設計を進めています。新システムではバックエンドのアーキテクチャはマイクロサービスで設計している為、それに対応する形でインフラ設計・構築を進めました。認証機能を持つサーバー、お惣菜の納品数を自動算出する機能を持つサーバーなど、役割ごとに複数のサーバーに分割して構成しています。さらに開発環境用のAWSアカウントとステージング・本番環境用のAWSアカウントを別々に用意してマルチアカウント運用をおこなっています。

それでは、実際のインフラ構成についてお話しします。

<br/>

### フロントエンド
フロンドエンドの構成は、CloudFront、S3 を使った構成にしています。AWSのベストプラクティスに準拠し、CloudFront の OAI（Origin Access Identity）からのみ静的コンテンツを提供をするようにすることで S3への直接アクセスを禁止にしました。WAF の組み合わせと AWS Certificate Manager でSSL証明書発行による HTTS通信にすることで低コスト・高セキュリティな構成になっています。

<br/>

### バックエンド
アプリケーションの実行環境は、ECS(Fargate)です。ローカル環境や本番環境の全てをコンテナ環境下に統一して環境差異を極力無くして開発を進められるようにしています。コンテナごとのパフォーマンスをContainer Insights を利用することで容易にモニタリングすることができています。

データベースは、Aurora MySQL です。バックアップを S3 へ継続的におこなってくれることや3つの AZ 間でレプリケーションをおこなっていることにより高可用性を実現します。負荷に応じた自動スケールアップ・ダウンが容易なことも、今後のOKANの事業成長に柔軟に対応していくことができるようになります。拡張モニタリングを有効にし、監視ログ・エラーログ・スロークエリログ等を容易に取得できるようになりました。

<br/>

### リリースフロー（CI/CD）
リリースフローは CodePipeline です。Code Build と Code Deploy を使用し、フロントとバックエンドの両方でCI/CD を構築しました。

CodeBuild を使ったビルド時には、自動テスト（Jest） をおこなうことで実装内容を担保しながら開発を進められるようにしています。自動テストの実装においては、まだ不十分なところもあるので引き続き実装を進めています。

デプロイは Code Deploy の Blue/Green Deployment です。本番環境と同等の環境を使って、本番環境への Deploy 検証をおこなえること、Deploy後に問題が発生した場合の切り戻しが容易にできることを考慮しました。

<br/>

## 既存のシステムの課題は改善できたのか
新システムは、既存のシステムの課題を改善できているのかお話ししていきます。

新システムはAWSマネジメントコンソールでAWSリソースを作成せずにコード化しました。Ia化ツールにはAWS の CloudFormationを使用しました。システムごと、環境ごとに関わらずに容易に同じインフラ環境を作成できるようになりました。今後、新規でシステムを開発することになった場合には、インフラ構築のための時間を大幅に短縮しつつ、迅速に構築することが可能になります。

AWSリソースを作成する際には予め定めておいた命名ルールに則り、Nameタグを付与するようにしたのでリソースを判別する際の視認性も大幅に向上しています。既存システムのように不要なAWSリソースが残ったままにならないように、不要になったら即時に削除することもルール化しています。Nameタグを使用した Cost Explorer でのコスト可視化がしやすくもなりました。

ところが、新システムのインフラ構築を開始してからは AWSの請求書処理の担当にもなってコストがどのくらいかかっているかの把握はできていましたが、詳細な内訳確認まではしていませんでした。Cost Explorer を見ていなかったのです。マネージャーにコストが増加している理由を指摘されて、初めて詳細な内訳の確認をしました。コスト管理を適切におこなうためには、コストを把握しやすい環境を整えるだけではなくて、コスト自体にも関心を常に持っておく必要がありますね。

インフラの設計・構築の初期の段階で CI/CD のリリースフローを構築したことで、既存システムのように作業手順書に沿って手作業でリリースしている作業が不要になりました。リリース作業工数の削減とミスの軽減になっていくので長期的にもメリットが大きいです。OKANでの過去のリリースミスは、多数のワーニングが出ていたがコンパイルが成功し、その状態でリリースをしてしまったことが原因だったのですが、新システムでは自動ビルド時に単体テストを実施しているので同じようなミスを極力無くしていくことができると考えています。

インフラの環境面だけではなく、それを使う人間のスキルなど、まだまだ改善していかないと行けない点はいっぱいあると思いますが、これまでと同じ過ちを繰り返さないようにし、より一層インフラ環境の整備と改善を進めていきたいと考えています。

<br/>

## おわりに
入社後すぐに新システムのインフラ担当となり、先輩方に助けて頂きながらなんとか最後までやりきることができました。コストを最適化しつつ、適切なインフラ設計・構築をする難しさを痛感しました。自分自身の課題は山積みなので、一つ一つ理解して進んでいきたいと思います。

現在は SREチームの一員として、OKANの複数のシステムの整備や、ITGC関連の業務をおこなっています。OKAMのシステム理解はもちろんのこと、ビジネス面での理解ももっと深めて、これまで以上に貢献できるように頑張っていきたいと思います！
